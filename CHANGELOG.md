# 変更履歴

## v2.2 (2024-11-23)

### ✨ 新機能
- **食事の編集機能**
  - 保存済みの食事を後から修正可能
  - モーダルウィンドウで編集
  - 日付、時刻、個人名、食品すべて変更可能

- **食事の削除機能**
  - 不要な食事記録を削除
  - 確認ダイアログで誤削除を防止
  - 関連データ（栄養素、食事項目）も自動削除

- **人物プルダウン選択**
  - データベースに記録されている人物名を自動取得
  - プルダウンから簡単に選択
  - 新規入力も可能
  - 選択時に自動的に週間サマリーも更新

- **DeepSeek AI統合**
  - デフォルトのAIエンジンをDeepSeekに変更
  - 高速・低コスト（$0.14/1M入力トークン）
  - Claudeはフォールバックとして継続サポート
  - AIなしモードも引き続き利用可能

### 🔧 改善
- 食事履歴に編集・削除ボタンを追加
- ユーザーインターフェースの改善
- エラーハンドリングの強化

### 🌐 新しいAPIエンドポイント
- `GET /api/persons`: 人物リスト取得
- `GET /api/meal/<id>`: 食事詳細取得
- `PUT /api/meal/<id>`: 食事更新
- `DELETE /api/meal/<id>`: 食事削除

### 📦 依存関係
- `requests==2.31.0`を追加（DeepSeek API呼び出し用）

## v2.1 (2024-11-23)

### 🐛 バグ修正
- **データベース初期化エラーを修正**
  - `init_db()`をモジュールレベルで実行するように変更
  - Gunicorn起動時にもデータベースが正しく初期化される
  - エラー: "no such table: meals" を解決

### 🔧 改善
- `anthropic`モジュールをオプショナルインポートに変更
  - ローカル環境でanthropicがなくても動作可能
  - AI機能は引き続き利用可能

### 📝 ドキュメント
- `TROUBLESHOOTING.md`を追加
  - よくあるエラーと解決方法を記載

## v2.0 (2024-11-23)

### ✨ 新機能
- **AIを使わない高速あいまい検索**
  - 4段階検索アルゴリズム（完全一致→正規化→キーワード→類似度）
  - 50+の食品名マッピング
  - Claude API不要（コスト$0）

### 🚀 パフォーマンス
- 検索速度の大幅向上
- APIコールなしで即座にマッチング

### 🎯 検索精度向上
- キーワードマッピングの拡充:
  - 穀類: 納豆、ご飯、白米、玄米、パン
  - 卵類: 生卵、卵、ゆで卵、目玉焼き
  - 肉類: 鶏もも肉、鶏むね肉、豚肉、牛肉、ささみ
  - 魚介: さんま、鮭、さば、まぐろ
  - 野菜: ほうれん草、キャベツ、大根、にんじん、ブロッコリー
  - 豆腐: 豆腐、絹豆腐、厚揚げ
  - 調味料: 味噌、醤油、つゆ、みりん、砂糖、塩

### 🔍 候補提案機能
- 食品が見つからない場合に類似食品を提案

### 📝 ドキュメント
- `README.md`: プロジェクト概要と使い方
- `SETUP.md`: 詳細なセットアップ手順
- `EXAMPLES.md`: 具体的な使用例
- `test_search.py`: 検索機能のテストスクリプト
- `test_local.py`: ローカル動作確認スクリプト

## v1.0 (初期リリース)

### 🎉 初期機能
- 食事記録機能
- Claude APIによる食品名マッチング
- 31種類の栄養素計算
- 週間サマリー表示
- 充足率の視覚化（レーダーチャート、プログレスバー）
- 食事履歴表示
- パスワード認証
- Renderへのデプロイ対応

---

## アップグレード方法

### GitHubから最新版を取得
```bash
git pull origin main
```

### Renderで自動デプロイ
GitHubにプッシュすると自動的に再デプロイされます。

### 環境変数の追加（v2.2）
```bash
DEEPSEEK_API_KEY=sk-xxxxx  # オプションだが推奨
```

### ローカルで更新
```bash
cd nutrition-calculator
git pull origin main
pip install -r requirements.txt
rm -f nutrition.db  # 既存のDBを削除
python3 app.py      # 新しいDBが自動作成される
```

---

## 互換性

### v2.1 → v2.2
- **互換性あり**: データベース構造は変更なし
- **新機能**: 編集・削除機能が追加
- **推奨**: DEEPSEEK_API_KEYの追加（オプション）

### v2.0 → v2.1
- **互換性あり**: データベース構造は同一
- **影響なし**: 既存のデータは保持されます

### v1.0 → v2.0
- **互換性あり**: データベース構造は同一
- **変更点**: Claude APIの使用がオプショナルに

---

## マイグレーションガイド

### v1.0/v2.0/v2.1からv2.2へ

1. **コードを更新**
```bash
git pull origin main
pip install -r requirements.txt
```

2. **DeepSeek APIキーを取得（オプション）**
- https://platform.deepseek.com/ でアカウント作成
- APIキーを取得

3. **環境変数を設定**
```bash
# Renderの場合
DEEPSEEK_API_KEY=sk-xxxxx
```

4. **デプロイ**
- GitHubにプッシュ
- Renderが自動的に再デプロイ

5. **動作確認**
- ログインして食事を記録
- 編集ボタン（✏️）が表示されることを確認
- 削除ボタン（🗑️）が表示されることを確認
- 人物プルダウンが表示されることを確認

---

## 既知の問題

### v2.2
- なし（現時点）

### 解決済み
- ✅ データベース初期化エラー（v2.1で修正）
- ✅ 食品が見つからない問題（v2.0で改善）

---

## 今後の予定

### v2.3 (予定)
- [ ] バッチ編集機能（複数食事を一度に編集）
- [ ] 食事のコピー機能
- [ ] CSVエクスポート機能

### v3.0 (予定)
- [ ] PostgreSQL対応（データ永続化）
- [ ] ユーザー登録・ログイン機能
- [ ] 食事写真の自動認識
- [ ] レシピ提案機能

---

## 貢献

バグ報告や機能リクエストは、GitHubのIssuesでお願いします。

## ライセンス

食品成分データは文部科学省「日本食品標準成分表（八訂）増補2023年」を使用しています。
